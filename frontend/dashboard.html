<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - StudyConnect</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">🎓 StudyConnect</div>
            <div class="nav-menu">
                <a href="#profile" class="nav-link">Profile</a>
                <a href="#peers" class="nav-link">Peers</a>
                <a href="#chat" class="nav-link">Chat</a>
                <button id="logoutBtn" class="btn btn-secondary">Logout</button>
            </div>
        </div>
    </nav>

    <main class="dashboard">
        <div class="container">
            <!-- Welcome Section -->
            <section class="welcome-section">
                <div class="welcome-card">
                    <div id="welcomeMessage" class="welcome-content">
                        <h2>Welcome back! <span id="userName">Loading...</span></h2>
                        <p id="userStream">Loading your profile...</p>
                    </div>
                    <div class="welcome-stats">
                        <div class="stat-item">
                            <span class="stat-number" id="streamPeersCount">-</span>
                            <span class="stat-label">Stream Peers</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="onlinePeersCount">-</span>
                            <span class="stat-label">Online Now</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Quick Actions -->
            <section class="quick-actions">
                <h3>Quick Actions</h3>
                <div class="action-cards">
                    <div class="action-card" onclick="showSection('peers')">
                        <div class="action-icon">👥</div>
                        <h4>Find Peers</h4>
                        <p>Connect with students from your stream</p>
                    </div>
                    <div class="action-card" onclick="showSection('skills')">
                        <div class="action-icon">🔧</div>
                        <h4>Skill Match</h4>
                        <p>Find peers with similar skills</p>
                    </div>
                    <div class="action-card" onclick="showSection('chat')">
                        <div class="action-icon">💬</div>
                        <h4>Chat Rooms</h4>
                        <p>Join discussions and collaborate</p>
                    </div>
                    <div class="action-card" onclick="showSection('profile')">
                        <div class="action-icon">👤</div>
                        <h4>My Profile</h4>
                        <p>View and edit your information</p>
                    </div>
                </div>
            </section>

            <!-- Dynamic Content Sections -->
            <div id="dynamicContent">

                <!-- Peers Section -->
                <section id="peersSection" class="content-section">
                    <div class="section-header">
                        <h3>👥 Your Stream Peers</h3>
                        <div class="filter-controls">
                            <select id="streamFilter">
                                <option value="">All Streams</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Information Technology">Information Technology</option>
                                <option value="Electronics & Telecommunication">Electronics & Telecommunication</option>
                            </select>
                            <select id="yearFilter">
                                <option value="">All Years</option>
                                <option value="1st Year">1st Year</option>
                                <option value="2nd Year">2nd Year</option>
                                <option value="3rd Year">3rd Year</option>
                                <option value="4th Year">4th Year</option>
                            </select>
                        </div>
                    </div>
                    <div id="peersGrid" class="peers-grid">
                        <!-- Peers will be loaded here -->
                    </div>
                </section>

                <!-- Skills Section -->
                <section id="skillsSection" class="content-section" style="display:none;">
                    <div class="section-header">
                        <h3>🔧 Skill-Based Matching</h3>
                        <div class="skills-filter">
                            <div class="skill-tags" id="skillTags">
                                <!-- Skill tags will be populated here -->
                            </div>
                        </div>
                    </div>
                    <div id="skillsGrid" class="peers-grid">
                        <!-- Skill-matched peers will be loaded here -->
                    </div>
                </section>

                <!-- Profile Section -->
                <section id="profileSection" class="content-section" style="display:none;">
                    <div class="section-header">
                        <h3>👤 My Profile</h3>
                        <button id="editProfileBtn" class="btn btn-primary">Edit Profile</button>
                    </div>
                    <div class="profile-card">
                        <div id="profileContent">
                            <!-- Profile content will be loaded here -->
                        </div>
                    </div>
                </section>

                <!-- Chat Section -->
                <section id="chatSection" class="content-section" style="display:none;">
                    <div class="section-header">
                        <h3>💬 Chat Rooms</h3>
                        <button id="createRoomBtn" class="btn btn-primary">Create Room</button>
                    </div>
                    <div class="chat-container">
                        <div class="chat-sidebar">
                            <h4>Available Rooms</h4>
                            <div id="chatRoomsList">
                                <!-- Chat rooms will be loaded here -->
                            </div>
                        </div>
                        <div class="chat-main">
                            <div id="chatMessages">
                                <p>Select a chat room to start messaging</p>
                            </div>
                            <div class="chat-input" style="display:none;">
                                <input type="text" id="messageInput" placeholder="Type your message...">
                                <button id="sendMessageBtn" class="btn btn-primary">Send</button>
                            </div>
                        </div>
                    </div>
                </section>

            </div>
        </div>
    </main>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">Loading...</div>
    </div>

    <!-- Firebase CDN Scripts -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // Your Firebase configuration (replace with actual values)
        const firebaseConfig = {
            apiKey: "AIzaSyDbf_X1WX67FhXiPJWDSLchiG6eDjR7JsM",
            authDomain: "student-collaboration-pl-37e06.firebaseapp.com",
            projectId: "student-collaboration-pl-37e06",
            storageBucket: "student-collaboration-pl-37e06.firebasestorage.app",
            messagingSenderId: "648204798579",
            appId: "1:648204798579:web:041b586930f18dcbfc3806",
            measurementId: "G-72358XSZVY"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        console.log('✅ Firebase initialized on dashboard');

        // Global variables
        let currentUser = null;
        let currentUserProfile = null;
        let authToken = null;

        // Show loading overlay
        function showLoading(show = true) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // API helper function
        async function apiRequest(endpoint, options = {}) {
            const defaultHeaders = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            };

            const response = await fetch(endpoint, {
                ...options,
                headers: { ...defaultHeaders, ...options.headers }
            });

            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Request failed');
            }
            
            return data;
        }

        // Load user profile
        async function loadUserProfile() {
            try {
                showLoading(true);
                const response = await apiRequest('/api/students/profile');
                currentUserProfile = response.student;
                
                // Update welcome message
                document.getElementById('userName').textContent = currentUserProfile.personalInfo.fullName;
                document.getElementById('userStream').textContent = 
                    `${currentUserProfile.academicDetails.stream} • ${currentUserProfile.academicDetails.currentYear}`;

                // Load peers count
                await loadStreamPeersCount();
                
                console.log('✅ User profile loaded:', currentUserProfile);
            } catch (error) {
                console.error('❌ Failed to load profile:', error);
                alert('Failed to load your profile. Please try refreshing the page.');
            } finally {
                showLoading(false);
            }
        }

        // Load peers count
        async function loadStreamPeersCount() {
            try {
                const response = await apiRequest(`/api/students/peers/${encodeURIComponent(currentUserProfile.academicDetails.stream)}`);
                document.getElementById('streamPeersCount').textContent = response.total;
                
                // Count online peers
                const onlineCount = response.peers.filter(peer => peer.isOnline).length;
                document.getElementById('onlinePeersCount').textContent = onlineCount;
            } catch (error) {
                console.error('❌ Failed to load peers count:', error);
            }
        }

        // Show specific section
        window.showSection = function(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionName + 'Section');
            if (targetSection) {
                targetSection.style.display = 'block';
                
                // Load section-specific content
                switch(sectionName) {
                    case 'peers':
                        loadStreamPeers();
                        break;
                    case 'skills':
                        loadSkillsSection();
                        break;
                    case 'profile':
                        loadProfileSection();
                        break;
                    case 'chat':
                        loadChatRooms();
                        break;
                }
            }
        };

        // Load stream peers
        async function loadStreamPeers() {
            try {
                const response = await apiRequest(`/api/students/peers/${encodeURIComponent(currentUserProfile.academicDetails.stream)}`);
                const peersGrid = document.getElementById('peersGrid');
                
                if (response.peers.length === 0) {
                    peersGrid.innerHTML = '<p class="no-peers">No peers found in your stream yet. Be the first to connect!</p>';
                    return;
                }
                
                peersGrid.innerHTML = response.peers.map(peer => `
                    <div class="peer-card">
                        <div class="peer-avatar">${peer.personalInfo.fullName.charAt(0)}</div>
                        <div class="peer-info">
                            <h4>${peer.personalInfo.fullName}</h4>
                            <p>${peer.academicDetails.stream}</p>
                            <p>${peer.academicDetails.currentYear}</p>
                            <div class="peer-skills">
                                ${peer.skillsInterests.mainSkills.slice(0, 3).map(skill => 
                                    `<span class="skill-tag">${skill}</span>`
                                ).join('')}
                            </div>
                            <div class="peer-status ${peer.isOnline ? 'online' : 'offline'}">
                                ${peer.isOnline ? '🟢 Online' : '🔴 Offline'}
                            </div>
                        </div>
                        <div class="peer-actions">
                            <button class="btn btn-sm btn-primary" onclick="startChat('${peer._id}', '${peer.personalInfo.fullName}')">
                                💬 Chat
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('❌ Failed to load peers:', error);
                document.getElementById('peersGrid').innerHTML = '<p class="error">Failed to load peers. Please try again.</p>';
            }
        }

        // Load skills section
        async function loadSkillsSection() {
            const skillsContainer = document.getElementById('skillTags');
            const userSkills = currentUserProfile.skillsInterests.mainSkills;
            
            // Show user's skills as clickable tags
            skillsContainer.innerHTML = userSkills.map(skill => 
                `<button class="skill-tag clickable" onclick="searchBySkill('${skill}')">${skill}</button>`
            ).join('');
            
            // Load peers with matching skills
            try {
                const response = await apiRequest('/api/students/peers/by-skills', {
                    method: 'POST',
                    body: JSON.stringify({ skills: userSkills })
                });
                
                const skillsGrid = document.getElementById('skillsGrid');
                
                if (response.peers.length === 0) {
                    skillsGrid.innerHTML = '<p class="no-peers">No peers found with matching skills yet.</p>';
                    return;
                }
                
                skillsGrid.innerHTML = response.peers.map(peer => `
                    <div class="peer-card">
                        <div class="peer-avatar">${peer.personalInfo.fullName.charAt(0)}</div>
                        <div class="peer-info">
                            <h4>${peer.personalInfo.fullName}</h4>
                            <p>${peer.academicDetails.stream} • ${peer.academicDetails.currentYear}</p>
                            <div class="match-score">
                                🎯 ${peer.matchScore} skill${peer.matchScore > 1 ? 's' : ''} match
                            </div>
                            <div class="peer-skills">
                                ${peer.matchingSkills.map(skill => 
                                    `<span class="skill-tag matched">${skill}</span>`
                                ).join('')}
                            </div>
                            <div class="peer-status ${peer.isOnline ? 'online' : 'offline'}">
                                ${peer.isOnline ? '🟢 Online' : '🔴 Offline'}
                            </div>
                        </div>
                        <div class="peer-actions">
                            <button class="btn btn-sm btn-primary" onclick="startChat('${peer._id}', '${peer.personalInfo.fullName}')">
                                💬 Chat
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('❌ Failed to load skill-based peers:', error);
                document.getElementById('skillsGrid').innerHTML = '<p class="error">Failed to load peers. Please try again.</p>';
            }
        }

        // Load profile section
        function loadProfileSection() {
            const profileContent = document.getElementById('profileContent');
            const profile = currentUserProfile;
            
            profileContent.innerHTML = `
                <div class="profile-grid">
                    <div class="profile-section">
                        <h4>Personal Information</h4>
                        <p><strong>Name:</strong> ${profile.personalInfo.fullName}</p>
                        <p><strong>Email:</strong> ${profile.personalInfo.collegeEmail}</p>
                        <p><strong>Roll Number:</strong> ${profile.personalInfo.rollNumber}</p>
                    </div>
                    <div class="profile-section">
                        <h4>Academic Details</h4>
                        <p><strong>Stream:</strong> ${profile.academicDetails.stream}</p>
                        <p><strong>Year:</strong> ${profile.academicDetails.currentYear}</p>
                        <p><strong>Cohort:</strong> ${profile.academicDetails.cohort}</p>
                    </div>
                    <div class="profile-section">
                        <h4>Skills & Interests</h4>
                        <div class="skills-list">
                            ${profile.skillsInterests.mainSkills.map(skill => 
                                `<span class="skill-tag">${skill}</span>`
                            ).join('')}
                        </div>
                        ${profile.skillsInterests.portfolioLink ? 
                            `<p><strong>Portfolio:</strong> <a href="${profile.skillsInterests.portfolioLink}" target="_blank">${profile.skillsInterests.portfolioLink}</a></p>` 
                            : ''}
                    </div>
                </div>
            `;
        }

        // Chat functionality (placeholder)
        window.startChat = function(peerId, peerName) {
            alert(`Starting chat with ${peerName} - Chat feature will be implemented in the next phase!`);
        };

        // Load chat rooms (placeholder)
        function loadChatRooms() {
            document.getElementById('chatRoomsList').innerHTML = `
                <div class="chat-room" onclick="selectChatRoom('general')">
                    <div class="room-name">🌐 General Discussion</div>
                    <div class="room-info">5 members online</div>
                </div>
                <div class="chat-room" onclick="selectChatRoom('cs')">
                    <div class="room-name">💻 Computer Science</div>
                    <div class="room-info">3 members online</div>
                </div>
                <p class="coming-soon">Real-time chat coming soon!</p>
            `;
        }

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log('✅ User signed out');
                window.location.href = '/';
            } catch (error) {
                console.error('❌ Logout failed:', error);
                alert('Logout failed. Please try again.');
            }
        });

        // Authentication state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log('👤 User is signed in:', user.email);
                currentUser = user;
                authToken = await user.getIdToken();
                
                // Load user profile and dashboard data
                await loadUserProfile();
                
                // Default to peers section
                showSection('peers');
                
            } else {
                console.log('👤 User is signed out, redirecting to login');
                window.location.href = '/login';
            }
        });

    </script>
</body>
</html>
