<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - StudyConnect</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/chat.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">üéì StudyConnect</div>
            <div class="nav-menu">
                <a href="#profile" class="nav-link" onclick="showSection('profile')">Profile</a>
                <a href="#peers" class="nav-link" onclick="showSection('peers')">Peers</a>
                <a href="#chat" class="nav-link" onclick="showSection('chat')">Chat</a>
                <div class="user-info">
                    <span id="navUserName">Loading...</span>
                    <div class="user-status" id="userStatus"></div>
                </div>
                <button id="logoutBtn" class="btn btn-secondary">Logout</button>
            </div>
        </div>
    </nav>

    <main class="dashboard">
        <div class="container">
            <!-- Welcome Section -->
            <section class="welcome-section">
                <div class="welcome-card">
                    <div id="welcomeMessage" class="welcome-content">
                        <h2>Welcome back! <span id="userName">Loading...</span></h2>
                        <p id="userStream">Loading your profile...</p>
                    </div>
                    <div class="welcome-stats">
                        <div class="stat-item">
                            <span class="stat-number" id="streamPeersCount">-</span>
                            <span class="stat-label">Stream Peers</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="onlinePeersCount">-</span>
                            <span class="stat-label">Online Now</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="activeChatRooms">-</span>
                            <span class="stat-label">Active Chats</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Quick Actions -->
            <section class="quick-actions">
                <h3>Quick Actions</h3>
                <div class="action-cards">
                    <div class="action-card" onclick="showSection('peers')">
                        <div class="action-icon">üë•</div>
                        <h4>Find Peers</h4>
                        <p>Connect with students from your stream</p>
                    </div>
                    <div class="action-card" onclick="showSection('skills')">
                        <div class="action-icon">üîß</div>
                        <h4>Skill Match</h4>
                        <p>Find peers with similar skills</p>
                    </div>
                    <div class="action-card" onclick="showSection('chat')">
                        <div class="action-icon">üí¨</div>
                        <h4>Chat Rooms</h4>
                        <p>Join discussions and collaborate</p>
                    </div>
                    <div class="action-card" onclick="showSection('profile')">
                        <div class="action-icon">üë§</div>
                        <h4>My Profile</h4>
                        <p>View and edit your information</p>
                    </div>
                </div>
            </section>

            <!-- Dynamic Content Sections -->
            <div id="dynamicContent">

                <!-- Peers Section -->
                <section id="peersSection" class="content-section">
                    <div class="section-header">
                        <h3>üë• Your Stream Peers</h3>
                        <div class="filter-controls">
                            <select id="streamFilter">
                                <option value="">All Streams</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Information Technology">Information Technology</option>
                                <option value="Electronics & Telecommunication">Electronics & Telecommunication</option>
                            </select>
                            <select id="yearFilter">
                                <option value="">All Years</option>
                                <option value="1st Year">1st Year</option>
                                <option value="2nd Year">2nd Year</option>
                                <option value="3rd Year">3rd Year</option>
                                <option value="4th Year">4th Year</option>
                            </select>
                        </div>
                    </div>
                    <div id="peersGrid" class="peers-grid">
                        <!-- Peers will be loaded here -->
                    </div>
                </section>

                <!-- Skills Section -->
                <section id="skillsSection" class="content-section" style="display:none;">
                    <div class="section-header">
                        <h3>üîß Skill-Based Matching</h3>
                        <div class="skills-filter">
                            <div class="skill-tags" id="skillTags">
                                <!-- Skill tags will be populated here -->
                            </div>
                        </div>
                    </div>
                    <div id="skillsGrid" class="peers-grid">
                        <!-- Skill-matched peers will be loaded here -->
                    </div>
                </section>

                <!-- Profile Section -->
                <section id="profileSection" class="content-section" style="display:none;">
                    <div class="section-header">
                        <h3>üë§ My Profile</h3>
                        <button id="editProfileBtn" class="btn btn-primary">Edit Profile</button>
                    </div>
                    <div class="profile-card">
                        <div id="profileContent">
                            <!-- Profile content will be loaded here -->
                        </div>
                    </div>
                </section>

                <!-- Chat Section -->
                <section id="chatSection" class="content-section" style="display:none;">
                    <div class="section-header">
                        <h3>üí¨ Chat Rooms</h3>
                        <div class="chat-controls">
                            <select id="streamChatFilter">
                                <option value="">All Streams</option>
                                <option value="Computer Science">CS Only</option>
                                <option value="Information Technology">IT Only</option>
                                <option value="Electronics & Telecommunication">ECE Only</option>
                            </select>
                            <button id="createRoomBtn" class="btn btn-primary">+ Create Room</button>
                        </div>
                    </div>
                    
                    <div class="chat-layout">
                        <!-- Chat Rooms Sidebar -->
                        <div class="chat-sidebar">
                            <div class="sidebar-section">
                                <h4>Available Rooms</h4>
                                <div id="chatRoomsList" class="chat-rooms-list">
                                    <!-- Chat rooms will be loaded here -->
                                </div>
                            </div>
                            
                            <div class="sidebar-section">
                                <h4>Online Users <span id="onlineCount" class="online-badge">0</span></h4>
                                <div id="onlineUsersList" class="online-users-list">
                                    <!-- Online users will be loaded here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chat Main Area -->
                        <div class="chat-main">
                            <div id="chatWelcome" class="chat-welcome">
                                <div class="welcome-content">
                                    <div class="chat-welcome-icon">üí¨</div>
                                    <h3>Welcome to StudyConnect Chat!</h3>
                                    <p>Select a chat room to start messaging with your peers, or create a new room to begin discussions.</p>
                                    <div class="quick-rooms">
                                        <button class="quick-room-btn" onclick="createDefaultRooms()">
                                            üåê Create General Room
                                        </button>
                                        <button class="quick-room-btn" onclick="createStreamRoom()">
                                            üéì Create Stream Room
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="chatActive" class="chat-active" style="display:none;">
                                <!-- Chat Header -->
                                <div class="chat-header">
                                    <div class="chat-room-info">
                                        <h4 id="currentRoomName">Room Name</h4>
                                        <span id="currentRoomParticipants" class="participants-count">0 participants</span>
                                    </div>
                                    <div class="chat-actions">
                                        <button id="chatSettingsBtn" class="btn btn-sm btn-secondary">‚öôÔ∏è</button>
                                        <button id="leaveChatBtn" class="btn btn-sm btn-secondary">üö™ Leave</button>
                                    </div>
                                </div>
                                
                                <!-- Messages Area -->
                                <div id="chatMessages" class="chat-messages">
                                    <!-- Messages will appear here -->
                                </div>
                                
                                <!-- Message Input -->
                                <div class="chat-input-area">
                                    <div class="message-input-container">
                                        <input 
                                            type="text" 
                                            id="messageInput" 
                                            class="message-input"
                                            placeholder="Type your message... (Press Enter to send)"
                                            maxlength="500"
                                        >
                                        <button id="sendMessageBtn" class="btn btn-primary send-btn">
                                            üì§
                                        </button>
                                    </div>
                                    <div class="typing-indicator" id="typingIndicator" style="display:none;">
                                        <span class="typing-dots"></span>
                                        Someone is typing...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

            </div>
        </div>
    </main>

    <!-- Create Room Modal -->
    <div id="createRoomModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Chat Room</h3>
                <button class="modal-close" onclick="closeCreateRoomModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createRoomForm">
                    <div class="form-group">
                        <label for="roomName">Room Name</label>
                        <input type="text" id="roomName" name="roomName" required maxlength="50"
                               placeholder="e.g., CS Project Discussions">
                    </div>
                    
                    <div class="form-group">
                        <label for="roomDescription">Description (Optional)</label>
                        <textarea id="roomDescription" name="roomDescription" maxlength="200"
                                  placeholder="What is this room for?"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="roomType">Room Type</label>
                        <select id="roomType" name="roomType" required>
                            <option value="general">General Discussion</option>
                            <option value="stream">Stream Specific</option>
                            <option value="study">Study Group</option>
                            <option value="project">Project Collaboration</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="streamGroup" style="display:none;">
                        <label for="roomStream">Select Stream</label>
                        <select id="roomStream" name="roomStream">
                            <option value="">Choose Stream</option>
                            <option value="Computer Science">Computer Science</option>
                            <option value="Information Technology">Information Technology</option>
                            <option value="Electronics & Telecommunication">Electronics & Telecommunication</option>
                        </select>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeCreateRoomModal()">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Create Room
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">Loading...</div>
    </div>

    <!-- Firebase CDN Scripts -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            query, 
            orderBy, 
            limit, 
            onSnapshot, 
            addDoc, 
            updateDoc, 
            setDoc, 
            serverTimestamp,
            where,
            getDocs,
            increment
        } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // Your Firebase configuration (replace with actual values)
        const firebaseConfig = {
            apiKey: "AIzaSyDbf_X1WX67FhXiPJWDSLchiG6eDjR7JsM",
            authDomain: "student-collaboration-pl-37e06.firebaseapp.com",
            projectId: "student-collaboration-pl-37e06",
            storageBucket: "student-collaboration-pl-37e06.firebasestorage.app",
            messagingSenderId: "648204798579",
            appId: "1:648204798579:web:041b586930f18dcbfc3806",
            measurementId: "G-72358XSZVY"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        console.log('‚úÖ Firebase initialized on dashboard');

        // Global variables
        let currentUser = null;
        let currentUserProfile = null;
        let authToken = null;
        let currentChatRoom = null;
        let messageListener = null;
        let onlineUsersListener = null;
        let roomsListener = null;

        // Chat state
        const chatState = {
            currentRoomId: null,
            currentRoomData: null,
            messages: [],
            onlineUsers: [],
            unsubscribers: []
        };

        // Show loading overlay
        function showLoading(show = true) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // API helper function
        async function apiRequest(endpoint, options = {}) {
            const defaultHeaders = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            };

            const response = await fetch(endpoint, {
                ...options,
                headers: { ...defaultHeaders, ...options.headers }
            });

            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Request failed');
            }
            
            return data;
        }

        // Update user presence
        async function updatePresence(isOnline = true) {
            try {
                const presenceRef = doc(db, 'presence', currentUser.uid);
                await setDoc(presenceRef, {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    displayName: currentUserProfile?.personalInfo?.fullName || currentUser.email,
                    stream: currentUserProfile?.academicDetails?.stream || 'Unknown',
                    isOnline: isOnline,
                    lastSeen: serverTimestamp(),
                    updatedAt: serverTimestamp()
                }, { merge: true });
                
                console.log(`üë§ Presence updated: ${isOnline ? 'online' : 'offline'}`);
            } catch (error) {
                console.error('‚ùå Error updating presence:', error);
            }
        }

        // Load user profile
        async function loadUserProfile() {
            try {
                showLoading(true);
                const response = await apiRequest('/api/students/profile');
                currentUserProfile = response.student;
                
                // Update welcome message
                document.getElementById('userName').textContent = currentUserProfile.personalInfo.fullName;
                document.getElementById('navUserName').textContent = currentUserProfile.personalInfo.fullName;
                document.getElementById('userStream').textContent = 
                    `${currentUserProfile.academicDetails.stream} ‚Ä¢ ${currentUserProfile.academicDetails.currentYear}`;

                // Update user presence in Firestore
                await updatePresence(true);
                
                // Load peers count
                await loadStreamPeersCount();
                
                console.log('‚úÖ User profile loaded:', currentUserProfile);
            } catch (error) {
                console.error('‚ùå Failed to load profile:', error);
                alert('Failed to load your profile. Please try refreshing the page.');
            } finally {
                showLoading(false);
            }
        }

        // Load peers count
        async function loadStreamPeersCount() {
            try {
                const response = await apiRequest(`/api/students/peers/${encodeURIComponent(currentUserProfile.academicDetails.stream)}`);
                document.getElementById('streamPeersCount').textContent = response.total;
                
                // Count online peers
                const onlineCount = response.peers.filter(peer => peer.isOnline).length;
                document.getElementById('onlinePeersCount').textContent = onlineCount;
            } catch (error) {
                console.error('‚ùå Failed to load peers count:', error);
            }
        }

        // Show specific section
        window.showSection = function(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionName + 'Section');
            if (targetSection) {
                targetSection.style.display = 'block';
                
                // Load section-specific content
                switch(sectionName) {
                    case 'peers':
                        loadStreamPeers();
                        break;
                    case 'skills':
                        loadSkillsSection();
                        break;
                    case 'profile':
                        loadProfileSection();
                        break;
                    case 'chat':
                        initChatSection();
                        break;
                }
            }
        };

        // ===== CHAT FUNCTIONALITY =====

        // Initialize chat section
        async function initChatSection() {
            console.log('üí¨ Initializing chat section');
            
            // Listen to chat rooms
            listenToChatRooms();
            
            // Listen to online users
            listenToOnlineUsers();
            
            // Load initial room count
            await loadChatRoomsCount();
        }

        // Listen to chat rooms in real-time
        function listenToChatRooms(streamFilter = null) {
            // Clean up existing listener
            if (roomsListener) {
                roomsListener();
            }

            let q = query(
                collection(db, 'chatRooms'),
                orderBy('lastActivity', 'desc'),
                limit(20)
            );
            
            if (streamFilter) {
                q = query(
                    collection(db, 'chatRooms'),
                    where('stream', '==', streamFilter),
                    orderBy('lastActivity', 'desc'),
                    limit(20)
                );
            }
            
            roomsListener = onSnapshot(q, (snapshot) => {
                const rooms = [];
                snapshot.forEach((doc) => {
                    rooms.push({
                        id: doc.id,
                        ...doc.data(),
                        createdAt: doc.data().createdAt?.toDate(),
                        lastActivity: doc.data().lastActivity?.toDate()
                    });
                });
                
                displayChatRooms(rooms);
                document.getElementById('activeChatRooms').textContent = rooms.length;
            }, (error) => {
                console.error('‚ùå Error listening to chat rooms:', error);
            });
        }

        // Display chat rooms in sidebar
        function displayChatRooms(rooms) {
            const roomsList = document.getElementById('chatRoomsList');
            
            if (rooms.length === 0) {
                roomsList.innerHTML = `
                    <div class="no-rooms">
                        <p>No chat rooms available</p>
                        <button class="btn btn-sm btn-primary" onclick="showCreateRoomModal()">
                            Create First Room
                        </button>
                    </div>
                `;
                return;
            }
            
            roomsList.innerHTML = rooms.map(room => {
                const isActive = chatState.currentRoomId === room.id;
                const lastActivity = room.lastActivity ? formatTimestamp(room.lastActivity) : 'New';
                const participantCount = room.participants ? room.participants.length : 0;
                
                return `
                    <div class="chat-room ${isActive ? 'active' : ''}" 
                         onclick="selectChatRoom('${room.id}', '${room.name}', ${JSON.stringify(room).replace(/"/g, '&quot;')})">
                        <div class="room-header">
                            <div class="room-name">${getRoomIcon(room.type)} ${room.name}</div>
                            <div class="room-time">${lastActivity}</div>
                        </div>
                        <div class="room-info">
                            <span class="participants">${participantCount} members</span>
                            ${room.stream ? `<span class="room-stream">‚Ä¢ ${room.stream}</span>` : ''}
                        </div>
                        ${room.description ? `<div class="room-description">${room.description}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Get room icon based on type
        function getRoomIcon(type) {
            const icons = {
                'general': 'üåê',
                'stream': 'üéì',
                'study': 'üìö',
                'project': 'üöÄ'
            };
            return icons[type] || 'üí¨';
        }

        // Listen to online users
        function listenToOnlineUsers() {
            if (onlineUsersListener) {
                onlineUsersListener();
            }

            const presenceRef = collection(db, 'presence');
            const q = query(presenceRef, where('isOnline', '==', true));
            
            onlineUsersListener = onSnapshot(q, (snapshot) => {
                const onlineUsers = [];
                snapshot.forEach((doc) => {
                    const userData = doc.data();
                    if (userData.uid !== currentUser.uid) { // Exclude current user
                        onlineUsers.push({
                            ...userData,
                            lastSeen: userData.lastSeen?.toDate()
                        });
                    }
                });
                
                displayOnlineUsers(onlineUsers);
                document.getElementById('onlineCount').textContent = onlineUsers.length;
            });
        }

        // Display online users
        function displayOnlineUsers(users) {
            const usersList = document.getElementById('onlineUsersList');
            
            if (users.length === 0) {
                usersList.innerHTML = '<div class="no-users">No other users online</div>';
                return;
            }
            
            usersList.innerHTML = users.map(user => `
                <div class="online-user">
                    <div class="user-avatar">${user.displayName.charAt(0).toUpperCase()}</div>
                    <div class="user-info">
                        <div class="user-name">${user.displayName}</div>
                        <div class="user-stream">${user.stream || 'Unknown'}</div>
                    </div>
                    <div class="user-status online">üü¢</div>
                </div>
            `).join('');
        }

        // Select and join a chat room
        window.selectChatRoom = async function(roomId, roomName, roomData) {
            try {
                // Leave current room first
                if (chatState.currentRoomId) {
                    await leaveChatRoom();
                }

                // Update UI to show active chat
                document.getElementById('chatWelcome').style.display = 'none';
                document.getElementById('chatActive').style.display = 'flex';
                
                // Update room info
                document.getElementById('currentRoomName').textContent = roomName;
                document.getElementById('currentRoomParticipants').textContent = 
                    `${roomData.participants?.length || 0} participants`;
                
                // Set current room
                chatState.currentRoomId = roomId;
                chatState.currentRoomData = roomData;
                
                // Update room participant list
                await updateRoomParticipants(roomId);
                
                // Listen to messages
                listenToMessages(roomId);
                
                // Update room list active state
                document.querySelectorAll('.chat-room').forEach(room => {
                    room.classList.remove('active');
                });
                document.querySelector(`[onclick*="${roomId}"]`)?.classList.add('active');
                
                console.log('üí¨ Joined chat room:', roomName);
            } catch (error) {
                console.error('‚ùå Error selecting chat room:', error);
                alert('Failed to join chat room. Please try again.');
            }
        };

        // Update room participants
        async function updateRoomParticipants(roomId) {
            try {
                const roomRef = doc(db, 'chatRooms', roomId);
                await updateDoc(roomRef, {
                    participants: [currentUser.uid], // This should be properly merged
                    lastActivity: serverTimestamp()
                });
            } catch (error) {
                console.error('‚ùå Error updating room participants:', error);
            }
        }

        // Listen to messages in a room
        function listenToMessages(roomId) {
            // Clean up existing message listener
            if (messageListener) {
                messageListener();
            }

            const messagesRef = collection(db, 'chatRooms', roomId, 'messages');
            const q = query(messagesRef, orderBy('timestamp', 'desc'), limit(50));
            
            messageListener = onSnapshot(q, (snapshot) => {
                const messages = [];
                snapshot.forEach((doc) => {
                    messages.push({
                        id: doc.id,
                        ...doc.data(),
                        timestamp: doc.data().timestamp?.toDate()
                    });
                });
                
                // Reverse to show oldest first
                messages.reverse();
                chatState.messages = messages;
                displayMessages(messages);
                
                // Scroll to bottom
                scrollToBottomOfChat();
            }, (error) => {
                console.error('‚ùå Error listening to messages:', error);
            });
        }

        // Display messages in chat
        function displayMessages(messages) {
            const messagesContainer = document.getElementById('chatMessages');
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="no-messages">
                        <p>No messages yet. Be the first to start the conversation!</p>
                    </div>
                `;
                return;
            }
            
            let lastSender = null;
            let lastDate = null;
            
            messagesContainer.innerHTML = messages.map(message => {
                const isOwnMessage = message.senderId === currentUser.uid;
                const messageDate = message.timestamp ? message.timestamp.toDateString() : '';
                const messageTime = message.timestamp ? formatTime(message.timestamp) : '';
                const showSender = lastSender !== message.senderId;
                const showDate = lastDate !== messageDate;
                
                lastSender = message.senderId;
                lastDate = messageDate;
                
                let html = '';
                
                // Show date separator
                if (showDate && messageDate) {
                    html += `<div class="date-separator">${messageDate}</div>`;
                }
                
                // Show message
                html += `
                    <div class="message ${isOwnMessage ? 'own-message' : 'other-message'} ${showSender ? 'new-sender' : ''}">
                        ${showSender && !isOwnMessage ? `<div class="message-sender">${message.senderName}</div>` : ''}
                        <div class="message-content">
                            <div class="message-text">${escapeHtml(message.text)}</div>
                            <div class="message-time">${messageTime}</div>
                        </div>
                    </div>
                `;
                
                return html;
            }).join('');
        }

        // Send a message
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            
            if (!messageText || !chatState.currentRoomId) {
                return;
            }
            
            try {
                const messagesRef = collection(db, 'chatRooms', chatState.currentRoomId, 'messages');
                await addDoc(messagesRef, {
                    text: messageText,
                    senderId: currentUser.uid,
                    senderName: currentUserProfile?.personalInfo?.fullName || currentUser.email,
                    senderEmail: currentUser.email,
                    type: 'text',
                    timestamp: serverTimestamp(),
                    edited: false
                });
                
                // Update room's last activity
                const roomRef = doc(db, 'chatRooms', chatState.currentRoomId);
                await updateDoc(roomRef, {
                    lastActivity: serverTimestamp(),
                    messageCount: increment(1)
                });
                
                // Clear input
                messageInput.value = '';
                
                console.log('üì§ Message sent');
            } catch (error) {
                console.error('‚ùå Error sending message:', error);
                alert('Failed to send message. Please try again.');
            }
        }

        // Leave current chat room
        async function leaveChatRoom() {
            if (messageListener) {
                messageListener();
                messageListener = null;
            }
            
            chatState.currentRoomId = null;
            chatState.currentRoomData = null;
            chatState.messages = [];
            
            // Update UI
            document.getElementById('chatWelcome').style.display = 'flex';
            document.getElementById('chatActive').style.display = 'none';
            
            // Update room list
            document.querySelectorAll('.chat-room').forEach(room => {
                room.classList.remove('active');
            });
        }

        // Create room modal functions
        window.showCreateRoomModal = function() {
            document.getElementById('createRoomModal').style.display = 'flex';
        };

        window.closeCreateRoomModal = function() {
            document.getElementById('createRoomModal').style.display = 'none';
            document.getElementById('createRoomForm').reset();
            document.getElementById('streamGroup').style.display = 'none';
        };

        // Create default rooms
        window.createDefaultRooms = function() {
            document.getElementById('roomName').value = 'General Discussion';
            document.getElementById('roomDescription').value = 'Open discussion for all students';
            document.getElementById('roomType').value = 'general';
            showCreateRoomModal();
        };

        window.createStreamRoom = function() {
            document.getElementById('roomName').value = `${currentUserProfile?.academicDetails?.stream || 'Stream'} Students`;
            document.getElementById('roomDescription').value = `Discussions for ${currentUserProfile?.academicDetails?.stream || 'stream'} students`;
            document.getElementById('roomType').value = 'stream';
            document.getElementById('roomStream').value = currentUserProfile?.academicDetails?.stream || '';
            document.getElementById('streamGroup').style.display = 'block';
            showCreateRoomModal();
        };

        // Handle room type change
        document.getElementById('roomType').addEventListener('change', function() {
            const streamGroup = document.getElementById('streamGroup');
            if (this.value === 'stream') {
                streamGroup.style.display = 'block';
                document.getElementById('roomStream').required = true;
            } else {
                streamGroup.style.display = 'none';
                document.getElementById('roomStream').required = false;
            }
        });

        // Handle create room form submission
        document.getElementById('createRoomForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const roomData = {
                name: formData.get('roomName'),
                description: formData.get('roomDescription') || '',
                type: formData.get('roomType'),
                stream: formData.get('roomStream') || null
            };
            
            try {
                showLoading(true);
                
                const roomsRef = collection(db, 'chatRooms');
                const newRoom = {
                    name: roomData.name,
                    description: roomData.description,
                    type: roomData.type,
                    stream: roomData.stream,
                    participants: [currentUser.uid],
                    moderators: [currentUser.uid],
                    createdBy: currentUser.uid,
                    createdAt: serverTimestamp(),
                    lastActivity: serverTimestamp(),
                    messageCount: 0,
                    isActive: true
                };
                
                const docRef = await addDoc(roomsRef, newRoom);
                console.log('‚úÖ Chat room created:', docRef.id);
                
                closeCreateRoomModal();
                
                // Auto-join the newly created room
                setTimeout(() => {
                    selectChatRoom(docRef.id, roomData.name, newRoom);
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Error creating room:', error);
                alert('Failed to create room. Please try again.');
            } finally {
                showLoading(false);
            }
        });

        // Message input event handlers
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);

        // Leave chat button
        document.getElementById('leaveChatBtn').addEventListener('click', leaveChatRoom);

        // Stream filter change
        document.getElementById('streamChatFilter').addEventListener('change', function() {
            const streamFilter = this.value;
            listenToChatRooms(streamFilter);
        });

        // Utility functions
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            
            const now = new Date();
            const messageTime = new Date(timestamp);
            const diffInMinutes = Math.floor((now - messageTime) / (1000 * 60));
            
            if (diffInMinutes < 1) return 'Just now';
            if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
            if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;
            
            return messageTime.toLocaleDateString();
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            return new Date(timestamp).toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottomOfChat() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function loadChatRoomsCount() {
            try {
                const roomsRef = collection(db, 'chatRooms');
                const snapshot = await getDocs(roomsRef);
                document.getElementById('activeChatRooms').textContent = snapshot.size;
            } catch (error) {
                console.error('‚ùå Error loading rooms count:', error);
            }
        }

        // ===== EXISTING FUNCTIONALITY (Peers, Profile, etc.) =====

        // Load stream peers
        async function loadStreamPeers() {
            try {
                const response = await apiRequest(`/api/students/peers/${encodeURIComponent(currentUserProfile.academicDetails.stream)}`);
                const peersGrid = document.getElementById('peersGrid');
                
                if (response.peers.length === 0) {
                    peersGrid.innerHTML = '<p class="no-peers">No peers found in your stream yet. Be the first to connect!</p>';
                    return;
                }
                
                peersGrid.innerHTML = response.peers.map(peer => `
                    <div class="peer-card">
                        <div class="peer-avatar">${peer.personalInfo.fullName.charAt(0)}</div>
                        <div class="peer-info">
                            <h4>${peer.personalInfo.fullName}</h4>
                            <p>${peer.academicDetails.stream}</p>
                            <p>${peer.academicDetails.currentYear}</p>
                            <div class="peer-skills">
                                ${peer.skillsInterests.mainSkills.slice(0, 3).map(skill => 
                                    `<span class="skill-tag">${skill}</span>`
                                ).join('')}
                            </div>
                            <div class="peer-status ${peer.isOnline ? 'online' : 'offline'}">
                                ${peer.isOnline ? 'üü¢ Online' : 'üî¥ Offline'}
                            </div>
                        </div>
                        <div class="peer-actions">
                            <button class="btn btn-sm btn-primary" onclick="startDirectChat('${peer._id}', '${peer.personalInfo.fullName}')">
                                üí¨ Chat
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('‚ùå Failed to load peers:', error);
                document.getElementById('peersGrid').innerHTML = '<p class="error">Failed to load peers. Please try again.</p>';
            }
        }

        // Load skills section
        async function loadSkillsSection() {
            const skillsContainer = document.getElementById('skillTags');
            const userSkills = currentUserProfile.skillsInterests.mainSkills;
            
            // Show user's skills as clickable tags
            skillsContainer.innerHTML = userSkills.map(skill => 
                `<button class="skill-tag clickable" onclick="searchBySkill('${skill}')">${skill}</button>`
            ).join('');
            
            // Load peers with matching skills
            try {
                const response = await apiRequest('/api/students/peers/by-skills', {
                    method: 'POST',
                    body: JSON.stringify({ skills: userSkills })
                });
                
                const skillsGrid = document.getElementById('skillsGrid');
                
                if (response.peers.length === 0) {
                    skillsGrid.innerHTML = '<p class="no-peers">No peers found with matching skills yet.</p>';
                    return;
                }
                
                skillsGrid.innerHTML = response.peers.map(peer => `
                    <div class="peer-card">
                        <div class="peer-avatar">${peer.personalInfo.fullName.charAt(0)}</div>
                        <div class="peer-info">
                            <h4>${peer.personalInfo.fullName}</h4>
                            <p>${peer.academicDetails.stream} ‚Ä¢ ${peer.academicDetails.currentYear}</p>
                            <div class="match-score">
                                üéØ ${peer.matchScore} skill${peer.matchScore > 1 ? 's' : ''} match
                            </div>
                            <div class="peer-skills">
                                ${peer.matchingSkills.map(skill => 
                                    `<span class="skill-tag matched">${skill}</span>`
                                ).join('')}
                            </div>
                            <div class="peer-status ${peer.isOnline ? 'online' : 'offline'}">
                                ${peer.isOnline ? 'üü¢ Online' : 'üî¥ Offline'}
                            </div>
                        </div>
                        <div class="peer-actions">
                            <button class="btn btn-sm btn-primary" onclick="startDirectChat('${peer._id}', '${peer.personalInfo.fullName}')">
                                üí¨ Chat
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('‚ùå Failed to load skill-based peers:', error);
                document.getElementById('skillsGrid').innerHTML = '<p class="error">Failed to load peers. Please try again.</p>';
            }
        }

        // Load profile section
        function loadProfileSection() {
            const profileContent = document.getElementById('profileContent');
            const profile = currentUserProfile;
            
            profileContent.innerHTML = `
                <div class="profile-grid">
                    <div class="profile-section">
                        <h4>Personal Information</h4>
                        <p><strong>Name:</strong> ${profile.personalInfo.fullName}</p>
                        <p><strong>Email:</strong> ${profile.personalInfo.collegeEmail}</p>
                        <p><strong>Roll Number:</strong> ${profile.personalInfo.rollNumber}</p>
                    </div>
                    <div class="profile-section">
                        <h4>Academic Details</h4>
                        <p><strong>Stream:</strong> ${profile.academicDetails.stream}</p>
                        <p><strong>Year:</strong> ${profile.academicDetails.currentYear}</p>
                        <p><strong>Cohort:</strong> ${profile.academicDetails.cohort}</p>
                    </div>
                    <div class="profile-section">
                        <h4>Skills & Interests</h4>
                        <div class="skills-list">
                            ${profile.skillsInterests.mainSkills.map(skill => 
                                `<span class="skill-tag">${skill}</span>`
                            ).join('')}
                        </div>
                        ${profile.skillsInterests.portfolioLink ? 
                            `<p><strong>Portfolio:</strong> <a href="${profile.skillsInterests.portfolioLink}" target="_blank">${profile.skillsInterests.portfolioLink}</a></p>` 
                            : ''}
                    </div>
                </div>
            `;
        }

        // Start direct chat with a peer
        window.startDirectChat = async function(peerId, peerName) {
            // Create or find direct chat room
            const roomName = `Direct: ${peerName}`;
            
            try {
                // Switch to chat section
                showSection('chat');
                
                // For now, show alert - you could implement direct messaging
                alert(`Direct messaging with ${peerName} will be available soon! For now, try creating a project room and inviting them.`);
                
            } catch (error) {
                console.error('‚ùå Error starting direct chat:', error);
            }
        };

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                // Update presence to offline
                await updatePresence(false);
                
                // Clean up chat listeners
                if (messageListener) messageListener();
                if (onlineUsersListener) onlineUsersListener();
                if (roomsListener) roomsListener();
                
                await signOut(auth);
                console.log('‚úÖ User signed out');
                window.location.href = '/';
            } catch (error) {
                console.error('‚ùå Logout failed:', error);
                alert('Logout failed. Please try again.');
            }
        });

        // Authentication state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log('üë§ User is signed in:', user.email);
                currentUser = user;
                authToken = await user.getIdToken();
                
                // Load user profile and dashboard data
                await loadUserProfile();
                
                // Default to peers section
                showSection('peers');
                
                // Set up presence heartbeat
                setInterval(() => updatePresence(true), 30000); // Update every 30 seconds
                
            } else {
                console.log('üë§ User is signed out, redirecting to login');
                window.location.href = '/login';
            }
        });

        // Handle page visibility change
        document.addEventListener('visibilitychange', () => {
            if (currentUser) {
                updatePresence(!document.hidden);
            }
        });

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                updatePresence(false);
            }
        });

    </script>
</body>
</html>
